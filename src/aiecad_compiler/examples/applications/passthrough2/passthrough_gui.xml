<?xml version="1.0" encoding="UTF-8"?>
<Module name="passthroughjit">

    <Symbols>
        <TypeAbstraction name="vector_ty">
            <ndarray>
                <shape>N</shape>
                <dtype>int32</dtype>
            </ndarray>
        </TypeAbstraction>

        <TypeAbstraction name="line_ty">
            <ndarray>
                <shape>N / 4</shape>
                <dtype>int32</dtype>
            </ndarray>
        </TypeAbstraction>
    </Symbols>

    <DataFlow>
        <!-- Base ObjectFifo from L3 to L2 -->
        <ObjectFifo name="of_in">
            <type>line_ty</type>
            <depth>2</depth>
        </ObjectFifo>

        <!-- Forward: of_out = of_in.cons().forward() -->
        <ObjectFifoForward name="of_out" source="of_in"/>

        <Runtime name="runtime">
            <Sequence inputs="vector_ty, vector_ty" as="a_in, c_out">
                <Fill target="of_in" source="a_in" use_tap="false">
                    <placement>Tile(0, 0)</placement>
                </Fill>

                <Drain source="of_out" target="c_out" use_tap="false">
                    <placement>Tile(0, 0)</placement>
                    <wait>true</wait>
                </Drain>
            </Sequence>
        </Runtime>

        <Program name="program">
            <device>current_device</device>
            <runtime>runtime</runtime>
            <placer>SequentialPlacer</placer>
        </Program>
    </DataFlow>

    <Function name="jit_function" decorator="iron.jit" entry="passthrough_dmas_jit">
        <parameters>
            <param name="inputA" type="vector_ty"/>
            <param name="outputC" type="vector_ty"/>
        </parameters>
        <body>
            <UseDataFlow/>
            <Return>program</Return>
        </body>
    </Function>

    <Function name="main_function" entry="main">
        <body>
            <Assign name="N" value="4096"/>

            <Tensor name="inputA">
                <init>iron.arange(N, dtype=np.int32, device="npu")</init>
            </Tensor>

            <Tensor name="outputC">
                <init>iron.zeros(N, dtype=np.int32, device="npu")</init>
            </Tensor>

            <Call function="jit_function" args="inputA, outputC"/>
        </body>
    </Function>

    <EntryPoint>
        <If condition="__name__ == '__main__'">
            <Call function="main_function"/>
        </If>
    </EntryPoint>

</Module>
