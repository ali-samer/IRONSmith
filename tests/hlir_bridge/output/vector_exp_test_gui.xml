<?xml version="1.0" ?>
<Module name="vector_exp_test">
    <Symbols>
        <Const name="N" type="int">65536</Const>
        <TypeAbstraction name="data_ty">
            <ndarray>
                <shape>N</shape>
                <dtype>bfloat16</dtype>
            </ndarray>
        </TypeAbstraction>
        <TypeAbstraction name="memtile_ty">
            <ndarray>
                <shape>N / 16</shape>
                <dtype>bfloat16</dtype>
            </ndarray>
        </TypeAbstraction>
        <TypeAbstraction name="tile_ty">
            <ndarray>
                <shape>N / 64</shape>
                <dtype>bfloat16</dtype>
            </ndarray>
        </TypeAbstraction>
    </Symbols>
    <DataFlow>
        <ExternalFunction name="exp_bf16_1024" operation="exp">
            <kernel>exp_bf16_1024</kernel>
            <source>/scratch/IRONSmithTesting/mlir-aie/aie_kernels/aie2/bf16_exp.cc</source>
            <arg_types>
                <type>tile_ty</type>
                <type>tile_ty</type>
            </arg_types>
            <include_dirs>
                <dir>/scratch/IRONSmithTesting/mlir-aie/aie_kernels</dir>
                <dir>/scratch/IRONSmithTesting/mlir-aie/aie_runtime_lib/AIE2</dir>
            </include_dirs>
        </ExternalFunction>
        <CoreFunction name="corefunc_exp" loop_count="N / 4096" operation="exp">
            <parameters>
                <param name="kernel" role="external_function"/>
                <param name="inputA" role="consumer"/>
                <param name="outputC" role="consumer"/>
            </parameters>
            <body>
                <Acquire source="outputC" count="1" name="elem_out"/>
                <Acquire source="inputA" count="1" name="elem_in"/>
                <Call function="kernel" args="elem_in, elem_out"/>
                <Release source="inputA" count="1"/>
                <Release source="outputC" count="1"/>
            </body>
        </CoreFunction>
        <ObjectFifo name="of_in_a">
            <type>memtile_ty</type>
            <depth>2</depth>
        </ObjectFifo>
        <ObjectFifo name="of_out_c">
            <type>memtile_ty</type>
            <depth>2</depth>
        </ObjectFifo>
        <ObjectFifoSplit name="split_a_col0" column="0" context="L2_L1" data="A">
            <source>of_in_a</source>
            <num_outputs>4</num_outputs>
            <output_type>tile_ty</output_type>
            <placement>Tile(0, 1)</placement>
        </ObjectFifoSplit>
        <ObjectFifoJoin name="join_c_col0" column="0" context="L1_L2" data="C">
            <dest>of_out_c</dest>
            <num_inputs>4</num_inputs>
            <input_type>tile_ty</input_type>
            <placement>Tile(0, 1)</placement>
        </ObjectFifoJoin>
        <Worker name="worker0" column="0" operation="exp" worker_index="0">
            <core_function>corefunc_exp</core_function>
            <arguments>
                <arg ref="exp_bf16_1024"/>
                <arg ref="split_a_col0" index="0" mode="consumer"/>
                <arg ref="join_c_col0" index="0" mode="producer"/>
            </arguments>
            <placement>Tile(0, 2)</placement>
        </Worker>
        <Worker name="worker1" column="0" operation="exp" worker_index="1">
            <core_function>corefunc_exp</core_function>
            <arguments>
                <arg ref="exp_bf16_1024"/>
                <arg ref="split_a_col0" index="1" mode="consumer"/>
                <arg ref="join_c_col0" index="1" mode="producer"/>
            </arguments>
            <placement>Tile(0, 3)</placement>
        </Worker>
        <Worker name="worker2" column="0" operation="exp" worker_index="2">
            <core_function>corefunc_exp</core_function>
            <arguments>
                <arg ref="exp_bf16_1024"/>
                <arg ref="split_a_col0" index="2" mode="consumer"/>
                <arg ref="join_c_col0" index="2" mode="producer"/>
            </arguments>
            <placement>Tile(0, 4)</placement>
        </Worker>
        <Worker name="worker3" column="0" operation="exp" worker_index="3">
            <core_function>corefunc_exp</core_function>
            <arguments>
                <arg ref="exp_bf16_1024"/>
                <arg ref="split_a_col0" index="3" mode="consumer"/>
                <arg ref="join_c_col0" index="3" mode="producer"/>
            </arguments>
            <placement>Tile(0, 5)</placement>
        </Worker>
        <Runtime name="runtime">
            <Sequence inputs="memtile_ty, memtile_ty" as="inputa_in, outputc_out">
                <Start>worker0, worker1, worker2, worker3</Start>
                <Fill target="of_in_a" source="inputa_in" data_ref="inputA" column="0" use_tap="false">
                    <placement>Tile(0, 0)</placement>
                </Fill>
                <Drain source="of_out_c" target="outputc_out" data_ref="outputC" column="0" use_tap="false">
                    <placement>Tile(0, 0)</placement>
                    <wait>true</wait>
                </Drain>
            </Sequence>
        </Runtime>
        <Program name="program">
            <device>current_device</device>
            <runtime>runtime</runtime>
            <placer>SequentialPlacer</placer>
        </Program>
    </DataFlow>
    <Function name="jit_function" decorator="iron.jit" entry="vector_exp_test_jit">
        <parameters>
            <param name="inputA" type="memtile_ty"/>
            <param name="outputC" type="memtile_ty"/>
        </parameters>
        <body>
            <UseDataFlow/>
            <Return>program</Return>
        </body>
    </Function>
    <Function name="main_function" entry="main">
        <body>
            <Assign name="N" value="65536"/>
            <Tensor name="inputA">
                <init>iron.arange(N, dtype=bfloat16, device="npu")</init>
            </Tensor>
            <Tensor name="outputC">
                <init>iron.zeros(N, dtype=bfloat16, device="npu")</init>
            </Tensor>
            <Call function="jit_function" args="inputA, outputC"/>
        </body>
    </Function>
    <EntryPoint>
        <If condition="__name__ == '__main__'">
            <Call function="main_function"/>
        </If>
    </EntryPoint>
</Module>